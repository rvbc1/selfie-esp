<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="author" content="Marek Knosala" />


    <link rel="stylesheet" href="styles.css">
    <!-- <link href='http://fonts.googleapis.com/css?family=Lato|Josefin+Sans&subset=latin,latin-ext' rel='stylesheet'
        type='text/css'> !-->

    <title>ESP32</title>

</head>

<body>
    <h1>Selfie Server 1.0</h1>
    <a href='/download'><button>Download</button></a>
    <a href='/upload'><button>Upload</button></a>
    <a href='/flash'><button>Flash</button></a>
    <button id="btn">Remove all</button>
    <h1>Files</h1>
    <div id='files'>

    </div>
    <ul>
        <li><a href='/'>Home</a></li>
        <li><a href='/download'>Download</a></li>
        <li><a href='/upload'>Upload</a></li>
    </ul>
    <footer>&copy; Marek Knosala 2020 ;)</footer>


    <script>

        var btn = document.getElementById('btn');

        btn.addEventListener('click', function () {
            var Request = new XMLHttpRequest();
            Request.open('GET', 'data.json');
            Request.onload = function () {
                var Data = JSON.parse(Request.responseText);
                console.log(Data);
                alert(JSON.stringify(Data));
            };
            Request.send();

        });

        function hideFile(file) {
            file.style.display = "none";
        }

        function showFiles(dir) {
            var all_files = document.querySelectorAll('[class="file"]');
            for (i = 0; i < all_files.length; i++) {
                // if(files[i].style.display == "none"){

                all_files[i].style.visibility = "hidden";
                all_files[i].setAttribute('is_hiden', "true");
                all_files[i].setAttribute('is_opened_folder', "false");
                // } else {
                //     files[i].style.display = "none";
                // }

            }

            var exists = document.querySelector('[id="' + dir + '"]') !== null;
            if (exists) {
                document.querySelector('[id="' + dir + '"]').style.display = "block";
                document.querySelector('[id="' + dir + '"]').style.visibility = "visible";
                document.querySelector('[id="' + dir + '"]').setAttribute('is_hiden', "false");
                document.querySelector('[id="' + dir + '"]').setAttribute('is_opened_folder', "true");
            }


            var selected_files = document.querySelectorAll('[up_folder="' + dir + '"]');
            for (i = 0; i < selected_files.length; i++) {
                // if(files[i].style.display == "none"){
                selected_files[i].style.display = "block";
                selected_files[i].style.visibility = "visible";
                selected_files[i].setAttribute('is_hiden', "false");
                // } else {
                //     files[i].style.display = "none";
                // }
            }

            all_files = document.querySelectorAll('[class="file"]');
            for (i = 0; i < all_files.length; i++) {
                if (all_files[i].style.visibility == "hidden") {
                    setTimeout(hideFile.bind(null, all_files[i]), 700);
                }
            }



        }

        var showFilesEvenetLisner = function (event, dir) {

            var file_dir = String(event, dir);

            var exists = document.querySelector('[up_folder="' + file_dir + '"]') !== null;
            if (exists) {
                if (document.querySelector('[up_folder="' + file_dir + '"]').style.visibility == "hidden") {
                    showFiles(file_dir);
                } else if (document.querySelector('[up_folder="' + file_dir + '"]').style.visibility == "visible") {
                    var up_dir = document.querySelector('[id="' + file_dir + '"]').getAttribute('up_folder');
                    showFiles(up_dir);
                }
            }
        }



        function generateFiles(items, dir = "") {
            for (var i = 0; i < items.length; i++) {
                var div = document.createElement('div');
                div.setAttribute('class', 'file');
                div.setAttribute('title', dir);
                div.setAttribute('up_folder', dir);
                div.setAttribute('is_opened_folder', "false");
                if (items[i].type == "Dir") {
                    div.setAttribute('type', "dir");
                }
                if (items[i].type == "File") {
                    div.setAttribute('type', "file");
                }

                var id = "";
                if(dir == "/" || dir == ""){
                    id = dir + items[i].name;
                } else {
                    id = dir + "/" + items[i].name;
                }

                div.setAttribute('id', id);
                div.style.display = "none";
                div.style.visibility = "hidden";
                div.setAttribute('is_hiden', "true");



                const file_name = document.createElement('div');
                file_name.setAttribute('class', 'file_name');
                file_name.innerHTML = items[i].name;

                if (items[i].type == "Dir" && items[i].name != "/") {
                    file_name.addEventListener('click', showFilesEvenetLisner.bind(event, id), false);
                }

                div.appendChild(file_name);


                var file_size = document.createElement('div');
                file_size.setAttribute('class', 'file_size');

                if (items[i].type == "File") {
                    file_size.innerHTML = 'file [' + items[i].size + ' bytes]';
                }

                if (items[i].type == "Dir") {
                    file_size.innerHTML = 'dir [' + items[i].Files.length + ' files]';
                }
                div.appendChild(file_size)



                var file_settings = document.createElement('div');
                file_settings.setAttribute('class', 'file_settings');
                file_settings.innerHTML = '';


                if (items[i].type == "File") {
                    var flash_file = document.createElement('img');
                    flash_file.id = "files_icon";
                    flash_file.src = "flash.png";
                    flash_file.alt = "flash";
                    file_settings.appendChild(flash_file);
                }


                if (items[i].type == "File") {
                    var download_link = document.createElement('a');
                    download_link.setAttribute('href', "download?name=" + id);

                    var download_file = document.createElement('img');
                    download_file.id = "files_icon";
                    download_file.src = "download.png";
                    download_file.alt = "download";

                    download_link.appendChild(download_file);
                    file_settings.appendChild(download_link);
                }

                if (items[i].type == "Dir") {
                    var input = document.createElement("input");
                    input.id = "mkdir_input";
                    input.type = "text";
                    input.maxLength="16";
                    input.placeholder="name";

                    var mkdir_link = document.createElement('a');
                    mkdir_link.setAttribute('href', "mkdir?name=");

                    var mkdir = document.createElement('img');
                    mkdir.id = "files_icon";
                    mkdir.src = "mkdir.png";
                    mkdir.alt = "mkdir";

                    mkdir_link.appendChild(mkdir);
                    file_settings.appendChild(input);
                    file_settings.appendChild(mkdir_link);
                }



                // ?arg1=3&arg2=4&arg3="arduino"

                var delete_link = document.createElement('a');
                delete_link.setAttribute('href', "delete?name=" + id);
                //   delete_link.src = "delete?name=" + items[i].name;

                var delete_file = document.createElement('img');
                delete_file.id = "files_icon";
                delete_file.src = "delete.png";
                delete_file.alt = "delete";

                delete_link.appendChild(delete_file);


                file_settings.appendChild(delete_link);

                div.appendChild(file_settings);


                document.getElementById("files").appendChild(div);
                if (items[i].type == "Dir") {
                    generateFiles(items[i].Files, id, false);
                }
            }
        }

        function ready() {
            var Request = new XMLHttpRequest();
            Request.open('GET', 'data.json');
            Request.onload = function () {
                var Data = JSON.parse(Request.responseText);

                var items = Data;
                generateFiles(items);
                showFiles("/");
            };
            Request.send();
        }

        document.addEventListener("DOMContentLoaded", ready);
    </script>
</body>

</html>